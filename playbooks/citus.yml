# This playbook is following the instructions on
#   https://docs.citusdata.com/en/v8.3/installation/multi_machine_debian.html#
- name: install postgres with citus
  hosts: all
  become: True
  tasks:
    - name: Add Citus repository for package manager
      script: deb.sh

    - name: install postgres
      apt: name=postgresql-11-citus-8.3 update_cache=yes

    - name: preload citus extension
      command: pg_conftool 11 main set shared_preload_libraries citus
      become: True
      register: out

    - debug: var=out.stdout_lines

    - name: pg listen on all IP interfaces
      command: pg_conftool 11 main set listen_addresses '*'
      become: True
      register: out

    - debug: var=out.stdout_lines

    - name: copy pg_hga.conf
      copy:
        src: pg_hga.conf
        dest: /etc/postgresql/11/main/pg_hba.conf
      become: True
      register: out

    - debug: var=out.stdout_lines

    - name: restart service postgresql
      service:
        name: postgresql
        state: restarted
      register: out

    - debug: var=out.stdout_lines

    - name: add the citus extension
      command: psql -c "CREATE EXTENSION citus;"
      become: True
      become_user: postgres
      register: out

    - debug: var=out.stdout_lines

- name: inform coordinator about workers
  hosts: coord
  become: True
  tasks:
    - name: create sql script
      template:
        src: add_workers.sql.j2
        dest: /tmp/add_workers.sql
        mode: u=rwx,g=r,o=r
      become: True
      become_user: postgres

    - name: run sql script
      command: psql -f /tmp/add_workers.sql
      become: True
      become_user: postgres
      register: out

    - debug: var=out.stdout_lines
